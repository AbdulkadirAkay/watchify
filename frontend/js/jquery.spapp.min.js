(function($) {
 
  $.spapp = function(options) {

    // set config and routes
    var config, routes = {};

    config = $.extend({
      defaultView  : $("main#spapp > section:last-child").attr("id"),
      templateDir  : './tpl/',
      pageNotFound : false
    }, options );

    $("main#spapp > section").each(function(k, e) {
      var elm = $(this);
      routes[elm.attr("id")] = {
        view     : elm.attr("id"),
        load     : elm.data("load"),
        onCreate : function() { },
        onReady  : function() { }
      }
    });
    // update rotues programatically
    this.route = function(options) { $.extend(routes[options.view], options); }

  // parse query parameters from hash
  var parseParams = function(hash) {
    var params = {};
    var queryString = hash.split('?')[1];
    if(queryString) {
      queryString.split('&').forEach(function(param) {
        var pair = param.split('=');
        params[decodeURIComponent(pair[0])] = decodeURIComponent(pair[1] || '');
      });
    }
    return params;
  }

  // manage hash change
  var lastHash = '';
  var routeChange = function() {
    var hash  = location.hash.slice(1);
    
    // Check if hash actually changed (including query params)
    if(hash === lastHash) {
      return;
    }
    lastHash = hash;
    
    var id    = hash.split('?')[0]; // extract route before query params
    var params = parseParams(hash);
    var route = routes[id];
    var elm   = $("#"+id);

    if( ! elm || ! route) {
      if(config.pageNotFound) {
        window.location.hash = config.pageNotFound;
        return;
      }
      console.log(id+" not defined");
      return;
    }

    // Hide all sections and show only the current one
    $("main#spapp > section").hide();
    elm.show();

    if(elm.hasClass("spapp-created")) {
      route.onReady(params);
    } else {
      elm.addClass("spapp-created");
      if( ! route.load) {
        route.onCreate(params);
        route.onReady(params);
      } else {
        elm.load(config.templateDir+route.load, function() {
          route.onCreate(params);
          route.onReady(params);
        });
      }
    }
  }

  // and run
  this.run = function() {
    window.addEventListener('hashchange', function() { routeChange(); });
    
    // Poll for hash changes (including query param changes) every 100ms
    setInterval(function() {
      routeChange();
    }, 100);
    
    if( ! window.location.hash) { window.location.hash = config.defaultView; } else { routeChange(); }
  }

    return this;
  };
 
}(jQuery));