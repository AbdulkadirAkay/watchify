<style>
    .cart-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 3rem 0;
        margin-bottom: 2rem;
    }
    
    .cart-item {
        border-bottom: 1px solid #e9ecef;
        padding: 1.5rem 0;
    }
    
    .cart-item:last-child {
        border-bottom: none;
    }
    
    .cart-item-image {
        width: 100px;
        height: 100px;
        object-fit: cover;
        border-radius: 8px;
    }
    
    .cart-summary {
        background: #f8f9fa;
        padding: 2rem;
        border-radius: 10px;
        position: sticky;
        top: 20px;
    }
    
    .empty-cart {
        text-align: center;
        padding: 4rem 2rem;
        color: #6c757d;
    }
    
    .empty-cart i {
        font-size: 5rem;
        margin-bottom: 1.5rem;
        color: #dee2e6;
    }
</style>

<!-- Cart Header -->
<div class="cart-header">
    <div class="container">
        <div class="text-center">
            <h1 class="display-4 fw-bold mb-3">Shopping Cart</h1>
            <p class="lead mb-0">Review your items before checkout</p>
        </div>
    </div>
</div>

<!-- Cart Content -->
<div class="container py-5">
    <!-- Empty Cart Message -->
    <div id="emptyCart" class="empty-cart d-none">
        <i class="bi-cart-x"></i>
        <h3>Your cart is empty</h3>
        <p class="mb-0">Add some products to get started!</p>
    </div>
    
    <div class="row" id="cartContent">
        <!-- Cart Items -->
        <div class="col-lg-8">
            <div id="cartItems">
                <!-- Cart items will be rendered here -->
            </div>
        </div>
        
        <!-- Cart Summary -->
        <div class="col-lg-4">
            <div id="cartSummary" class="cart-summary d-none">
                <h4 class="fw-bold mb-4">Order Summary</h4>
                <div class="d-flex justify-content-between mb-3">
                    <span>Subtotal (<span id="totalItems">0</span> items)</span>
                    <span class="fw-bold">$<span id="subtotal">0.00</span></span>
                </div>
                <div class="d-flex justify-content-between mb-3">
                    <span>Shipping</span>
                    <span class="text-success">Free</span>
                </div>
                <hr>
                <div class="d-flex justify-content-between mb-4">
                    <span class="h5 fw-bold">Total</span>
                    <span class="h5 fw-bold text-primary">$<span id="total">0.00</span></span>
                </div>
                <button class="btn btn-primary w-100 mb-2" onclick="proceedToCheckout()">
                    Proceed to Checkout
                </button>
                <button class="btn btn-outline-danger w-100" onclick="clearCart()">
                    <i class="bi-trash me-2"></i>Clear Cart
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Initialize cart page
function initCart() {
    console.log('Cart page initialized');
    renderCart();
}

// Render cart items
function renderCart() {
    if (typeof CartService === "undefined") {
        console.error("CartService not available");
        return;
    }
    
    var cart = CartService.getCart();
    var $cartItems = $("#cartItems");
    var $emptyCart = $("#emptyCart");
    var $cartSummary = $("#cartSummary");
    var $cartContent = $("#cartContent");
    
    if (!cart || cart.length === 0) {
        $cartItems.empty();
        $emptyCart.removeClass("d-none");
        $cartSummary.addClass("d-none");
        $cartContent.addClass("d-none");
        return;
    }
    
    $emptyCart.addClass("d-none");
    $cartSummary.removeClass("d-none");
    $cartContent.removeClass("d-none");
    $cartItems.empty();
    
    cart.forEach(function(item) {
        var itemHtml = createCartItemHtml(item);
        $cartItems.append(itemHtml);
    });
    
    updateCartSummary();
}

// Create cart item HTML
function createCartItemHtml(item) {
    var img = item.image_url || "images/no-image-placeholder.png";
    var price = parseFloat(item.price) || 0;
    var itemTotal = (price * item.quantity).toFixed(2);
    
    return `
        <div class="cart-item">
            <div class="row align-items-center">
                <div class="col-md-2">
                    <img src="${img}" alt="${item.name || ''}" class="cart-item-image">
                </div>
                <div class="col-md-4">
                    <h5 class="mb-1">${item.name || 'Unnamed product'}</h5>
                    <p class="text-muted mb-0">${item.brand || ''}</p>
                </div>
                <div class="col-md-2">
                    <p class="mb-0 fw-bold">$${price.toFixed(2)}</p>
                </div>
                <div class="col-md-2">
                    <div class="input-group">
                        <button class="btn btn-sm btn-outline-secondary" type="button" 
                                onclick="updateItemQuantity(${item.productId}, ${item.quantity - 1})">
                            <i class="bi-dash"></i>
                        </button>
                        <input type="text" class="form-control form-control-sm text-center" 
                               value="${item.quantity}" readonly style="max-width: 50px;">
                        <button class="btn btn-sm btn-outline-secondary" type="button"
                                onclick="updateItemQuantity(${item.productId}, ${item.quantity + 1})">
                            <i class="bi-plus"></i>
                        </button>
                    </div>
                </div>
                <div class="col-md-2 text-end">
                    <p class="mb-2 fw-bold">$${itemTotal}</p>
                    <button class="btn btn-sm btn-outline-danger" onclick="removeItem(${item.productId})">
                        <i class="bi-trash"></i>
                    </button>
                </div>
            </div>
        </div>
    `;
}

// Update cart summary
function updateCartSummary() {
    if (typeof CartService === "undefined") return;
    
    var itemCount = CartService.getCartItemCount();
    var total = CartService.getCartTotal();
    
    $("#totalItems").text(itemCount);
    $("#subtotal").text(total.toFixed(2));
    $("#total").text(total.toFixed(2));
}

// Update item quantity
function updateItemQuantity(productId, newQuantity) {
    if (typeof CartService === "undefined") return;
    
    CartService.updateQuantity(productId, newQuantity);
    renderCart();
}

// Remove item from cart
function removeItem(productId) {
    if (typeof CartService === "undefined") return;
    
    if (confirm("Are you sure you want to remove this item from your cart?")) {
        CartService.removeFromCart(productId);
        renderCart();
        
        if (typeof Utils !== "undefined" && Utils.showSuccess) {
            Utils.showSuccess("Item removed from cart.");
        }
    }
}

// Clear entire cart
function clearCart() {
    if (typeof CartService === "undefined") return;
    
    if (confirm("Are you sure you want to clear your entire cart?")) {
        CartService.clearCart();
        renderCart();
        
        if (typeof Utils !== "undefined" && Utils.showSuccess) {
            Utils.showSuccess("Cart cleared.");
        }
    }
}

// Proceed to checkout
function proceedToCheckout() {
    if (typeof CartService === "undefined") return;
    
    var cart = CartService.getCart();
    if (!cart || cart.length === 0) {
        if (typeof Utils !== "undefined" && Utils.showError) {
            Utils.showError("Your cart is empty.");
        }
        return;
    }
    
    // TODO: Check if user is logged in
    var token = localStorage.getItem("user_token");
    if (!token) {
        if (typeof Utils !== "undefined" && Utils.showError) {
            Utils.showError("Please login to proceed to checkout.");
        }
        window.location.hash = "#login";
        return;
    }
    
    // Navigate to checkout page
    window.location.hash = "#checkout";
}

// Initialize on page load
if (window.location.hash.includes("#cart")) {
    initCart();
}

// Listen for hash changes to reinitialize if user navigates back to cart
$(window).on('hashchange', function() {
    if (window.location.hash.includes("#cart")) {
        initCart();
    }
});
</script>
