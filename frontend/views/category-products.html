<style>
    .category-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 3rem 0;
        margin-bottom: 2rem;
    }
    
    .category-breadcrumb {
        background-color: #f8f9fa;
        padding: 1rem 0;
        border-bottom: 1px solid #e9ecef;
    }
    
    .breadcrumb {
        margin-bottom: 0;
    }
    
    .breadcrumb-item + .breadcrumb-item::before {
        content: ">";
    }
    
    .products-grid {
        padding: 2rem 0;
    }
    .filter-section {
        background: white;
        border-radius: 10px;
        padding: 1.5rem;
        margin-bottom: 2rem;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }
    
    .loading-spinner {
        display: none;
        text-align: center;
        padding: 3rem;
    }
    
    .no-products {
        text-align: center;
        padding: 3rem;
        color: #6c757d;
    }
</style>

<!-- Category Header -->
<div class="category-header">
    <div class="container">
        <div class="text-center">
            <h1 class="display-4 fw-bold mb-3" id="categoryTitle">Loading Category...</h1>
            <p class="lead mb-0" id="categoryDescription">Discover our amazing collection</p>
        </div>
    </div>
</div>

<!-- Breadcrumb -->
<div class="category-breadcrumb">
    <div class="container">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="#home" class="text-decoration-none">Home</a></li>
                <li class="breadcrumb-item"><a href="#" class="text-decoration-none" id="breadcrumbCategory">Categories</a></li>
                <li class="breadcrumb-item active" aria-current="page" id="breadcrumbCurrent">Products</li>
            </ol>
        </nav>
    </div>
</div>

<div class="container">
    
    <!-- Loading Spinner -->
    <div class="loading-spinner" id="loadingSpinner">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-3">Loading products...</p>
    </div>
    
    <!-- Products Grid -->
    <div class="products-grid" id="productsGrid">
        <div class="row gx-4 gx-lg-5 row-cols-1 row-cols-md-2 row-cols-xl-4" id="productsContainer">
            <!-- Products will be loaded here -->
        </div>
    </div>
    
    <!-- No Products Message -->
    <div class="no-products" id="noProducts" style="display: none;">
        <i class="bi-box display-1 text-muted"></i>
        <h4 class="mt-3">No products found</h4>
        <p class="text-muted">We couldn't find any products in this category.</p>
        <a href="#home" class="btn btn-primary">Continue Shopping</a>
    </div>
</div>

<script>
// Get category ID from URL hash query parameters
function getCategoryId() {
    const hash = window.location.hash;
    let categoryId = null;
    
    if (hash && hash.includes('?')) {
        const hashParts = hash.split('?');
        if (hashParts.length > 1) {
            const queryString = hashParts[1];
            const urlParams = new URLSearchParams(queryString);
            categoryId = urlParams.get('id');
        }
    }
    
    return categoryId;
}

// Load category details from backend
function loadCategoryDetails(categoryId, callback) {
    RestClient.get(
        'api/categories/' + categoryId,
        function(res) {
            if (res && res.success && res.data) {
                const category = res.data;
                // Update page header with category info from database
                $('#categoryTitle').text(category.name + ' Watches');
                $('#categoryDescription').text('Discover our collection of ' + category.name + ' watches');
                $('#breadcrumbCategory').text(category.name + ' Collection');
                $('#breadcrumbCurrent').text(category.name);
                
                if (callback) callback();
            } else {
                // Fallback if category not found
                $('#categoryTitle').text('Category Watches');
                $('#categoryDescription').text('Discover our amazing collection');
                $('#breadcrumbCategory').text('Categories');
                $('#breadcrumbCurrent').text('Products');
                
                if (callback) callback();
            }
        },
        function(error) {
            // Fallback on error
            $('#categoryTitle').text('Category Watches');
            $('#categoryDescription').text('Discover our amazing collection');
            $('#breadcrumbCategory').text('Categories');
            $('#breadcrumbCurrent').text('Products');
            
            if (callback) callback();
        }
    );
}

// Load products based on category ID
function loadProducts() {
    const categoryId = getCategoryId();
    
    if (!categoryId) {
        Utils.showError("Category not specified");
        $('#loadingSpinner').hide();
        $('#productsGrid').hide();
        $('#noProducts').show();
        return;
    }
    
    // Show loading spinner
    $('#loadingSpinner').show();
    $('#productsGrid').hide();
    $('#noProducts').hide();
    
    // First load category details, then load products
    loadCategoryDetails(categoryId, function() {
        // Call backend to get products for this category
        RestClient.get(
            'api/products/category/' + categoryId,
            function(res) {
                $('#loadingSpinner').hide();

                if (!res || !res.success || !Array.isArray(res.data) || res.data.length === 0) {
                    $('#productsGrid').hide();
                    $('#noProducts').show();

                    if (!res || !res.success) {
                        Utils.showError(
                            (res && (res.message || res.error)) || 'Failed to load products'
                        );
                    }
                    return;
                }

                renderProducts(res.data);
                $('#productsGrid').show();
                $('#noProducts').hide();
            },
            function(jqXHR) {
                $('#loadingSpinner').hide();
                $('#productsGrid').hide();
                $('#noProducts').show();

                const res = jqXHR && jqXHR.responseJSON;
                const msg = (res && (res.message || res.error)) ||
                            jqXHR.responseText ||
                            'Failed to load products';
                Utils.showError(msg);
            }
        );
    });
}

// Render products
function renderProducts(products) {
    const container = $('#productsContainer');
    container.empty();
    
    products.forEach(product => {
        const productCard = ProductService.createProductCard(product);
        container.append(productCard);
    });
}


// Initialize page - this will be called by spapp's onReady
function initCategoryProducts(params) {
    console.log('Category products initialized with params:', params);
    loadProducts();
}

// Listen for hash changes to reload products
$(window).on('hashchange', function() {
    const hash = window.location.hash;
    if (hash.startsWith('#category-products')) {
        loadProducts();
    }
});
</script>
